{% set sIdKey = "category" %}
{% set blShowMultipleSelector = true %}
<div class="item category {{ cssclass }}" id="atid_category">
    {% block d3_inc_ext_search__filter_category_title %}
        <label for="searchcategory">
            {{ translate({ ident: "D3_EXTSEARCH_EXT_CATEGORIES" }) }}
        </label><br>
    {% endblock %}

    {% set displayTypes = { "combined": "combined", "single": "single" } %}

    {% if sCategoryFilterDisplayType in displayTypes %}
        {% block d3_inc_ext_search__filter_category_single %}
            <SELECT class="form-select" id="searchcategory" name="searchcnid" onchange="d3_extsearch_popup.popup.load(); this.form.submit();">
                {% if sSelectedCategoryId %}
                    {% set blShowMultipleSelector = false %}
                    <OPTION class="desc" value="">{{ translate({ ident: "D3_EXTSEARCH_EXT_SEARCHINCATEGORIES" }) }}</OPTION>
                    <OPTION value="{{ sSelectedCategoryId }}" selected="selected">{{ sSelectedCategory }}</OPTION>
                {% else %}
                    <OPTION class="desc" value="" selected="selected">{{ translate({ ident: "D3_EXTSEARCH_EXT_CHOOSECAT" }) }}</OPTION>
                    {% for category in oView.d3getCategoryList() %}
                        <OPTION value="{{ category.getId() }}">{{ category.oxcategories__oxtitle.getRawValue() }}
                            {% if not oModCfg_d3_extsearch.getValue('blExtSearch_dontShowFilterArticleCount') and category.getFieldData('counter') %}
                                ({{ category.getFieldData('counter') }})
                            {% endif %}
                        </OPTION>
                    {% endfor %}
                {% endif %}
            </SELECT>

            <noscript>
                <div id="searchcategorysubmit" class="fullitem">
                    <button type="submit" class="submitButton largeButton btn {% if oModCfg_d3_extsearch.isThemeIdMappedTo('wave') %}btn-outline-primary {# for Bootstrap 4 #}{% elseif oModCfg_d3_extsearch.isThemeIdMappedTo('apex') %}btn-outline-primary {# for Bootstrap 5 #}{% endif %} btn-sm" onclick="d3_extsearch_popup.popup.load();">{{ translate({ ident: "D3_EXTSEARCH_EXT_ASSIGNFILTER" }) }}</button>
                </div>
            </noscript>
        {% endblock %}
    {% endif %}

    {% set displayTypes = { "combined": "combined", "multi": "multi" } %}

    {% if sCategoryFilterDisplayType in displayTypes %}
        {% block d3_inc_ext_search__filter_category_multi %}
            <div class="multiselect" id="d3searchcategory__multi" style="{% if sCategoryFilterDisplayType == 'combined' %}display: none;{% endif %}">
                {% for valuekey, category in oView.d3getCategoryList() %}
                    <div class="multiselectvalue" id="d3searchcategory__multi__{{ valuekey }}">
                        <input name="d3searchcategorymulti[{{ category.getId() }}]" type="hidden" value="">
                        <input name="d3searchcategorymulti[{{ category.getId() }}]" class="form-check-input" type="checkbox" value="{{ category.getId() }}" id="cb{{ key }}{{ category.getId() }}" {% if category.selected or category.getId() == sSelectedCategoryId %} checked{% endif %}>
                        <label for="cb{{ key }}{{ category.getId() }}">
                            {{ category.getTitle() }} {% if not oModCfg_d3_extsearch.getValue('blExtSearch_dontShowFilterArticleCount') and category.getFieldData('counter') %}({{ category.getFieldData('counter') }}){% endif %}
                        </label>
                    </div>
                {% endfor %}

                {% block d3_inc_ext_search__filter_category_multibuttons %}
                    {% include "@d3_extsearch/filterelements/inc/multibuttons.html.twig" with {type: "category"} %}
                {% endblock %}
            </div>
        {% endblock %}
    {% endif %}

    {% block d3_inc_ext_search__filter_category_multiselector %}
        {% if sCategoryFilterDisplayType == 'combined' %}
            <div id="d3searchcategory__multiselector" class="filterselector {% if false == blShowMultipleSelector %}filterselector_hidden{% endif %}">
                <input type="checkbox" class="form-check-input" name="d3searchcategorymultiselector" id="d3searchcategorymultiselector" onclick="toggleMultiCategory(this.checked);">
                <label for="d3searchcategorymultiselector">
                    {% set categorytranslation = "CATEGORY"|translate %}
                    {{ oView.d3GetMultipleSelectionTranslation(categorytranslation) }}
                </label>
            </div>

            {% set d3JsFnc %}{% apply spaceless %}
                function toggleMultiCategory(blChecked) {
                    if (blChecked) {
                        document.getElementById('d3searchcategory__multi').style.display = 'block';
                        document.getElementById('searchcategory').style.display = 'none';
                        if (buttonElement = document.getElementById('searchcategorysubmit')) {
                            buttonElement.style.display = 'none';
                        }
                        document.getElementById('d3searchcategory__multiselector').style.display = 'none';
                    }
                }
            {% endapply %}{% endset %}
            {{ script({ add: d3JsFnc.__toString(), dynamic: __oxid_include_dynamic }) }}

            {% if oView.d3CategoryFilterUseMultipleValues() %}
                {% set d3JsFnc %}{% apply spaceless %}
                    toggleMultiCategory(true);
                    document.getElementById('d3searchcategorymultiselector').checked = 'checked';
                {% endapply %}{% endset %}
                {{ script({ add: d3JsFnc.__toString(), dynamic: __oxid_include_dynamic }) }}
            {% endif %}
        {% elseif sCategoryFilterDisplayType == 'single' %}
            <input type="hidden" value="" name="d3searchcategorymultiselector" id="d3searchcategorymultiselector">
        {% elseif sCategoryFilterDisplayType == 'multi' %}
            <input type="hidden" value="on" name="d3searchcategorymultiselector" id="d3searchcategorymultiselector">
        {% endif %}
    {% endblock %}
</div>