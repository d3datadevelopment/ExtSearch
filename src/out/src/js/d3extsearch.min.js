/**
 * This Software is the property of Data Development and is protected
 * by copyright law - it is NOT Freeware.
 * Any unauthorized use of this software without a valid license
 * is a violation of the license agreement and will be prosecuted by
 * civil and criminal law.
 * http://www.shopmodule.com
 *
 * @license
 * @copyright (C) D3 Data Development (Inh. Thomas Dartsch)
 * @author    D3 Data Development - Daniel Seifert <support@shopmodule.com>
 * @link      http://www.oxidmodule.com
 */
$(function(){"use strict";$.widget("ui.d3extsearchsuggest",{options:{currentEvent:null,oAjaxResponseElement:null,isSend:0,coloredId:null,oldColoredId:null,iActLine:null,iCode:null,blNavigate:null,iRet:null,sSelection:null,oSelection:null,iDelay:600,iMinCharCount:3,sD3SearchBoxDefault:"",sWaitMessage:"",sParentThemeId:"flow",sRequestUrl:null,sSearchFormId:"search",sCloseBtnId:"d3extsearch_suggest_closebtn",sResultListId:"#searchItemList",sResultItemClass:".d3QSItem",sStartSearchButtonId:"d3extsearch_suggest_startsearch",sResponseElementId:"xajax_resp",sResponseElementClass:"xajax_resp_cl",sWaitMsgIdentificator:"#d3_extsearch_quicksearch.searchWaitMsg",sRequestFncName:"getSuggestContent",sSearchParamName:"searchParam",sActClassName:"item_act",sInactClassName:"item_inact",sActiveElementClassName:null,blSetActiveElementDimensions:!0,sActiveElementStyleTop:null,sActiveElementStyleTopImportant:"",sActiveElementStyleLeft:null,sActiveElementStyleLeftImportant:"",blAutomatedActiveElementStyleWidth:!1,sActiveElementStyleWidth:null,sActiveElementStyleWidthImportant:"",iScrollTopOffset:29,blEnableLeftRightNavigation:!0,blToggleLeftRightDirection:!1},_create:function(){let t=this,e=this.element;this.addResponseElement(),e.keyup(function(e){t.keyHandler(e)})},addResponseElement:function(){let e=this.options;var t=$("#"+e.sResponseElementId);0===t.length?e.oAjaxResponseElement=$("<div>",{id:e.sResponseElementId,class:e.sResponseElementClass+" xajax_resp_"+e.sParentThemeId}).appendTo("body"):e.oAjaxResponseElement=t},mouseHandler:function(e,t){let s=this.options;s.oldColoredId=s.coloredId,s.coloredId=e,s.iActLine=t,s.blNavigate=!0,this.changeResultItemColor(s.coloredId,s.oldColoredId)},keyHandler:function(e){e.preventDefault();let t=this.options;var s="submit"===(t.currentEvent=e).type.toLowerCase();let o=s?"Enter":e.originalEvent.key;s||"enter"===o.toLowerCase()||t.oAjaxResponseElement.is(":visible")?"arrowup"===o.toLowerCase()?this.handleArrowUpKey():"arrowleft"!==o.toLowerCase()&&"pageup"!==o.toLowerCase()||!t.blEnableLeftRightNavigation?"arrowright"!==o.toLowerCase()&&"pagedown"!==o.toLowerCase()||!t.blEnableLeftRightNavigation?"arrowdown"===o.toLowerCase()?this.handleArrowDownKey():"enter"===o.toLowerCase()?t.blNavigate?this.handleEnterKeyOnSelectedItem():this.handleEnterKeyWithoutSelectedItem():"escape"===o.toLowerCase()?this.handleEscapeKey():this.handleOtherKeys():this.handleArrowRightKey():this.handleArrowLeftKey():this.showSuggestWindow()},handleArrowUpKey:function(){let e=this.options;0<e.iActLine&&e.iActLine--,e.coloredId&&(e.oldColoredId=e.coloredId),e.blNavigate=!0,e.coloredId=this.getResultItemIdByLine(e.iActLine),this.changeResultItemColor(e.coloredId,e.oldColoredId)},handleArrowDownKey:function(){let e=this.options;var t=this.getResultItemCount();e.iActLine<t-1&&e.iActLine++,e.coloredId&&(e.oldColoredId=e.coloredId),e.blNavigate=!0,e.coloredId=this.getResultItemIdByLine(e.iActLine),this.changeResultItemColor(e.coloredId,e.oldColoredId)},handleArrowLeftKey:function(){let e=this.options,t=null,s=null;var o,n=this.getTypesList();e.iActLine<0?(t=0,s=0):null!==(o=$("#"+this.getResultItemIdByLine(e.iActLine)).attr("data-object-type"))?o&&o.length&&1<n.length&&(t=$.inArray(o,n),s=e.blToggleLeftRightDirection?1:-1):console.error("selected item has no data-object-type attribute, can not switch to next group"),null!==t&&(n=n[t+s],null!==(n=this.findFirstElementIdByObjectType(n))&&(e.coloredId&&(e.oldColoredId=e.coloredId),e.coloredId=n,this.changeResultItemColor(e.coloredId,e.oldColoredId),e.oldColoredId=e.coloredId))},handleArrowRightKey:function(){let e=this.options,t=null,s=null;var o,n=this.getTypesList();e.iActLine<0?(t=0,s=0):(o=$("#"+this.getResultItemIdByLine(e.iActLine)).attr("data-object-type"))?o&&o.length&&1<n.length&&(t=$.inArray(o,n),s=e.blToggleLeftRightDirection?-1:1):console.error("selected item has no data-object-type attribute, can not switch to next group"),null!==t&&(n=n[t+s],(n=this.findFirstElementIdByObjectType(n))&&(e.coloredId&&(e.oldColoredId=e.coloredId),e.coloredId=n,this.changeResultItemColor(e.coloredId,e.oldColoredId),e.oldColoredId=e.coloredId))},getTypesList:function(){let t=[];return this.getResultItemListElement().each(function(){var e=$(this).attr("data-object-type");e?e.length&&$.inArray(e,t)<0&&t.push(e):console.error("no data-object-type attributes for grouping found")}),t},findFirstElementIdByObjectType:function(t){let s=this.options,o=null;return this.getResultItemListElement().each(function(e){if($(this).attr("data-object-type")===t)return s.iActLine=e,o=$(this).attr("id"),!1}),o},handleEnterKeyOnSelectedItem:function(){var e=this.options;let t=$("#"+this.getResultItemIdByLine(e.iActLine));window.location.href=t.attr("href")},handleEnterKeyWithoutSelectedItem:function(){var e=this.options;e.isSend&&(window.clearTimeout(e.isSend),this.hideSuggest());let t=$("#"+e.sSearchFormId);t.off("submit"),t.submit()},handleEscapeKey:function(){this.hideSuggest()},handleOtherKeys:function(){var e=this.options.currentEvent.originalEvent.key;"ArrowLeft"!==e&&"ArrowRight"!==e&&this.showSuggestWindow()},showSuggestWindow:function(){let e=this.options;if("enter"!==e.currentEvent.originalEvent.key.toLowerCase())return 0===$(e.sWaitMsgIdentificator).length?this.showWaitMessage():(this.showWaitMessage(),e.isSend&&window.clearTimeout(e.isSend)),e.isSend=setTimeout(function(){this.showResult()}.bind(this),e.iDelay),null},showWaitMessage:function(){let e=this.options;e.oAjaxResponseElement.html($("<div/>").html(e.sWaitMessage).text()),this.setResponseElementStyle()},showResult:function(){let s=this.options,o=this.element;if(!1===Number.isFinite(s.iMinCharCount)||o.val().length<s.iMinCharCount)this.hideSuggest();else{let t=this;$.get(s.sRequestUrl+"fnc="+s.sRequestFncName+"&"+s.sSearchParamName+"="+o.val(),function(e){o.val()===e.searchparam&&(s.oAjaxResponseElement.html(e.content),t.setItemsMouseHandler(),t.setResponseElementStyle(),t.setStartSearchButtonHandler())}),s.iActLine=-1,s.coloredId=-1,s.oldColoredId=-1,s.blNavigate=!1}},setResponseElementStyle:function(){let t=this,e=this.options,s=this.element;e.sActiveElementClassName&&e.oAjaxResponseElement.addClass(e.sActiveElementClassName),e.blSetActiveElementDimensions&&(e.oAjaxResponseElement.get(0).style.setProperty("top",e.sActiveElementStyleTop||(s[0].hasAttribute("suggestTopOffsetPx")?s.offset().top+(s.height()+5)+parseInt(s.attr("suggestTopOffsetPx"),10)+"px":s.offset().top+(s.height()+5)+"px"),e.sActiveElementStyleTopImportant),e.oAjaxResponseElement.get(0).style.setProperty("left",e.sActiveElementStyleLeft||(s[0].hasAttribute("suggestLeftOffsetPx")?s.offset().left+parseInt(s.attr("suggestLeftOffsetPx"),10)+"px":s.offset().left+"px"),e.sActiveElementStyleLeftImportant),e.blAutomatedActiveElementStyleWidth&&e.oAjaxResponseElement.get(0).style.setProperty("width",e.sActiveElementStyleWidth||s.width()+"px",e.sActiveElementStyleWidthImportant)),this.showSuggest(),e.oAjaxResponseElement.click(function(e){e.stopPropagation()}),this.element.click(function(e){e.stopPropagation()}),$("body").click(function(){t.hideSuggest()}),$("#"+e.sCloseBtnId).click(function(e){e.stopPropagation(),t.hideSuggest()})},showSuggest:function(){this.options.oAjaxResponseElement.addClass("suggestVisible")},hideSuggest:function(){this.options.oAjaxResponseElement.removeClass("suggestVisible")},getResultItemListElement:function(){var e=this.options;return $(e.sResultListId).find("a"+e.sResultItemClass)},getResultItemCount:function(){return this.getResultItemListElement().length},getResultItemIdByLine:function(t){let s=null;return this.getResultItemListElement().each(function(e){e===t&&(s=$(this).attr("id"))}),s},changeResultItemColor:function(e,t){var s=this.options;-1!==t&&t!==e&&$("#"+t).addClass(s.sInactClassName).removeClass(s.sActClassName),t!==e&&$("#"+e).addClass(s.sActClassName).removeClass(s.sInactClassName),this.scrollToSelectedElement(e)},scrollToSelectedElement:function(e){var t=this.options;let s=t.currentEvent,o=$("#"+e);if(!(0===o.length||0<=s.type.toLowerCase().indexOf("mouse"))){let e=$(t.sResultListId);t=o.position().top+e.scrollTop()-t.iScrollTopOffset;e.stop(!0).animate({scrollTop:t},"slow")}},setItemsMouseHandler:function(){let s=this,o=this.options;this.getResultItemListElement().each(function(t){$(this).mouseover(function(e){o.currentEvent=e;e=s.getResultItemIdByLine(t);s.mouseHandler(e,t)})})},setStartSearchButtonHandler:function(){let t=this;var e=this.options;$("#"+e.sStartSearchButtonId).click(function(e){e.preventDefault(),t.handleEnterKeyWithoutSelectedItem()})}})}(jQuery));