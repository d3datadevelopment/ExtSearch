/**
 * This Software is the property of Data Development and is protected
 * by copyright law - it is NOT Freeware.
 * Any unauthorized use of this software without a valid license
 * is a violation of the license agreement and will be prosecuted by
 * civil and criminal law.
 * http://www.shopmodule.com
 * 
 * @license
 * @copyright (C) D3 Data Development (Inh. Thomas Dartsch)
 * @author    D3 Data Development - Daniel Seifert <support@shopmodule.com>
 * @link      http://www.oxidmodule.com
 */
$(function(){$.widget("ui.d3extsearchsuggest",{options:{currentEvent:null,oAjaxResponseElement:null,isSend:0,coloredId:null,oldColoredId:null,iActLine:null,iCode:null,blNavigate:null,iRet:null,sSelection:null,oSelection:null,iDelay:600,sD3SearchBoxDefault:"",sWaitMessage:"",sParentThemeId:"flow",sRequestUrl:null,sSearchFormId:"search",sCloseBtnId:"d3extsearch_suggest_closebtn",sResultListId:"#searchItemList",sResultItemClass:".d3QSItem",sStartSearchButtonId:"d3extsearch_suggest_startsearch",sResponseElementId:"xajax_resp",sResponseElementClass:"xajax_resp_cl",sWaitMsgIdentificator:"#d3_extsearch_quicksearch.searchWaitMsg",sRequestFncName:"getSuggestContent",sSearchParamName:"searchParam",sActClassName:"item_act",sInactClassName:"item_inact",sActiveElementStyleDisplay:"block",sActiveElementStyleTop:null,sActiveElementStyleLeft:null,blAutomatedActiveElementStyleWidth:!1,sActiveElementStyleWidth:null,iScrollTopOffset:29,blEnableLeftRightNavigation:!0,blToggleLeftRightDirection:!1},_create:function(){var a=this,b=this.element,c=this.options;this.addResponseElement(),b.keyup(function(b){a.keyHandler(b)}),$("#"+c.sSearchFormId).submit(function(b){a.keyHandler(b)})},addResponseElement:function(){var a=this.options,b=$("#"+a.sResponseElementId);0===b.length?a.oAjaxResponseElement=$("<div>",{id:a.sResponseElementId,class:a.sResponseElementClass+" xajax_resp_"+a.sParentThemeId}).appendTo("body"):a.oAjaxResponseElement=b},mouseHandler:function(a,b){var c=this.options;c.oldColoredId=c.coloredId,c.coloredId=a,c.iActLine=b,c.blNavigate=!0,this.changeResultItemColor(c.coloredId,c.oldColoredId)},keyHandler:function(a){a.preventDefault();var b=this.options;b.currentEvent=a;var c="submit"===a.type.toLowerCase(),d=c?"Enter":a.key;c||b.oAjaxResponseElement.is(":visible")?"arrowup"===d.toLowerCase()?this.handleArrowUpKey():"arrowleft"!==d.toLowerCase()&&"pageup"!==d.toLowerCase()||!b.blEnableLeftRightNavigation?"arrowright"!==d.toLowerCase()&&"pagedown"!==d.toLowerCase()||!b.blEnableLeftRightNavigation?"arrowdown"===d.toLowerCase()?this.handleArrowDownKey():"enter"===d.toLowerCase()?b.blNavigate?this.handleEnterKeyOnSelectedItem():this.handleEnterKeyWithoutSelectedItem():"escape"===d.toLowerCase()?this.handleEscapeKey():this.handleOtherKeys():this.handleArrowRightKey():this.handleArrowLeftKey():this.showSuggestWindow()},handleArrowUpKey:function(){var a=this.options;a.iActLine>0&&a.iActLine--,a.coloredId&&(a.oldColoredId=a.coloredId),a.blNavigate=!0,a.coloredId=this.getResultItemIdByLine(a.iActLine),this.changeResultItemColor(a.coloredId,a.oldColoredId)},handleArrowDownKey:function(){var a=this.options,b=this.getResultItemCount();a.iActLine<b-1&&a.iActLine++,a.coloredId&&(a.oldColoredId=a.coloredId),a.blNavigate=!0,a.coloredId=this.getResultItemIdByLine(a.iActLine),this.changeResultItemColor(a.coloredId,a.oldColoredId)},handleArrowLeftKey:function(){var a=this.options,b=null,c=null,d=this.getTypesList();if(a.iActLine<0)b=0,c=0;else{var e=$("#"+this.getResultItemIdByLine(a.iActLine)).attr("data-object-type");null!==e?e&&e.length&&d.length>1&&(b=$.inArray(e,d),c=a.blToggleLeftRightDirection?1:-1):console.error("selected item has no data-object-type attribute, can not switch to next group")}if(null!==b){var f=d[b+c],g=this.findFirstElementIdByObjectType(f);null!==g&&(a.coloredId&&(a.oldColoredId=a.coloredId),a.coloredId=g,this.changeResultItemColor(a.coloredId,a.oldColoredId),a.oldColoredId=a.coloredId)}},handleArrowRightKey:function(){var a=this.options,b=null,c=null,d=this.getTypesList();if(a.iActLine<0)b=0,c=0;else{var e=$("#"+this.getResultItemIdByLine(a.iActLine)).attr("data-object-type");e?e&&e.length&&d.length>1&&(b=$.inArray(e,d),c=a.blToggleLeftRightDirection?-1:1):console.error("selected item has no data-object-type attribute, can not switch to next group")}if(null!==b){var f=d[b+c],g=this.findFirstElementIdByObjectType(f);g&&(a.coloredId&&(a.oldColoredId=a.coloredId),a.coloredId=g,this.changeResultItemColor(a.coloredId,a.oldColoredId),a.oldColoredId=a.coloredId)}},getTypesList:function(){var a=[];return this.getResultItemListElement().each(function(){var b=$(this).attr("data-object-type");b?b.length&&$.inArray(b,a)<0&&a.push(b):console.error("no data-object-type attributes for grouping found")}),a},findFirstElementIdByObjectType:function(a){var b=this.options,c=null;return this.getResultItemListElement().each(function(d){if($(this).attr("data-object-type")===a)return b.iActLine=d,c=$(this).attr("id"),!1}),c},handleEnterKeyOnSelectedItem:function(){var a=this.options,b=$("#"+this.getResultItemIdByLine(a.iActLine));window.location.href=b.attr("href")},handleEnterKeyWithoutSelectedItem:function(){var a=this.options;a.isSend&&(window.clearTimeout(a.isSend),a.oAjaxResponseElement.hide());var b=$("#"+a.sSearchFormId);b.off("submit"),b.submit()},handleEscapeKey:function(){this.options.oAjaxResponseElement.hide()},handleOtherKeys:function(){var a=this.options,b=a.currentEvent,c=b.key;"ArrowLeft"!==c&&"ArrowRight"!==c&&this.showSuggestWindow()},showSuggestWindow:function(){var a=this.options;if("enter"!==a.currentEvent.key.toLowerCase())return 0===$(a.sWaitMsgIdentificator).length?(this.showWaitMessage(),a.isSend=window.setTimeout(this.showResult(),0)):(this.showWaitMessage(),a.isSend&&window.clearTimeout(a.isSend),a.isSend=window.setTimeout(this.showResult(),a.iDelay)),null},showWaitMessage:function(){var a=this.options;a.oAjaxResponseElement.html($("<div/>").html(a.sWaitMessage).text()),this.setResponseElementStyle()},showResult:function(){var a=this.options,b=this.element,c=this;$.get(a.sRequestUrl+"fnc="+a.sRequestFncName+"&"+a.sSearchParamName+"="+b.val(),function(b){a.oAjaxResponseElement.html(b),c.setItemsMouseHandler(),c.setResponseElementStyle(),c.setStartSearchButtonHandler()}),a.iActLine=-1,a.coloredId=-1,a.oldColoredId=-1,a.blNavigate=!1},setResponseElementStyle:function(){function a(){this.top=b.sActiveElementStyleTop?b.sActiveElementStyleTop:c.offset().top+(c.height()+5)+"px",this.left=b.sActiveElementStyleLeft?b.sActiveElementStyleLeft:c.offset().left+"px",b.blAutomatedActiveElementStyleWidth&&(this.width=b.sActiveElementStyleWidth?b.sActiveElementStyleWidth:c.width()+"px")}var b=this.options,c=this.element;b.oAjaxResponseElement.show().css(new a).click(function(a){a.stopPropagation()}),this.element.click(function(a){a.stopPropagation()}),$("body").click(function(){b.oAjaxResponseElement.hide()}),$("#"+b.sCloseBtnId).click(function(a){a.stopPropagation(),b.oAjaxResponseElement.hide()})},getResultItemListElement:function(){var a=this.options;return $(a.sResultListId).find("a"+a.sResultItemClass)},getResultItemCount:function(){return this.getResultItemListElement().length},getResultItemIdByLine:function(a){var b=null;return this.getResultItemListElement().each(function(c,d){c===a&&(b=$(this).attr("id"))}),b},changeResultItemColor:function(a,b){var c=this.options;-1!==b&&b!==a&&$("#"+b).addClass(c.sInactClassName).removeClass(c.sActClassName),b!==a&&$("#"+a).addClass(c.sActClassName).removeClass(c.sInactClassName),this.scrollToSelectedElement(a)},scrollToSelectedElement:function(a){var b=this.options,c=b.currentEvent,d=$("#"+a);if(!(0===d.length||c.type.toLowerCase().indexOf("mouse")>=0)){var e=$(b.sResultListId),f=d.position().top+e.scrollTop()-b.iScrollTopOffset;e.stop(!0).animate({scrollTop:f},"slow")}},setItemsMouseHandler:function(){var a=this,b=this.options;this.getResultItemListElement().each(function(c){$(this).mouseover(function(d){b.currentEvent=d;var e=a.getResultItemIdByLine(c);a.mouseHandler(e,c)})})},setStartSearchButtonHandler:function(){var a=this,b=this.options;$("#"+b.sStartSearchButtonId).click(function(b){b.preventDefault(),a.handleEnterKeyWithoutSelectedItem()})}})}(jQuery));